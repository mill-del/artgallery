{% extends 'base.html' %}

{% block content %}
    <div class="hero-section">
        <h1>Art Gallery</h1>
    </div>
    <div class="search-section mb-4">
        <h3>Filter Paintings</h3>
        <form method="GET" action="{{ url_for('blog.home') }}">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="query" class="form-label">Search by title, content, or author</label>
                    <input type="text" name="query" id="query" class="form-control" value="{{ request.args.get('query', '') }}">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="tag" class="form-label">Filter by tag</label>
                    <select name="tag" id="tag" class="form-control">
                        <option value="">All tags</option>
                        {% for tag in tags %}
                            <option value="{{ tag.name }}" {% if request.args.get('tag') == tag.name %}selected{% endif %}>{{ tag.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
    </div>
    <div class="posts-section">
        <div class="row">
            {% for post in posts %}
                <div class="col-md-4" data-post-container-id="{{ post.id }}">
                    <div class="post-card" data-post-id="{{ post.id }}">
                        {% if post.image %}
                            <img src="{{ url_for('static', filename='uploads/' + post.image) }}" alt="Post image">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ post.title }}</h5>
                            <p class="card-text">{{ post.content | truncate(100) }}</p>
                            <p class="card-text"><small class="text-muted">Posted by {{ post.author.username }} on {{ post.date_posted.strftime('%Y-%m-%d') }}</small></p>
                            {% if post.tags %}
                                <p class="card-text"><small class="text-muted">Tags: {{ post.tags | map(attribute='name') | join(', ') }}</small></p>
                            {% endif %}
                            <a href="{{ url_for('blog.view_post', post_id=post.id) }}" class="btn btn-primary">Read More</a>
                            {% if session['user_id'] == post.user_id %}
                                <a href="{{ url_for('blog.edit_post', post_id=post.id) }}" class="btn btn-primary">Edit</a>
                                <button class="btn btn-danger delete-post-btn" data-post-id="{{ post.id }}" data-bs-toggle="modal" data-bs-target="#deleteModal" onclick="setDeletePostId({{ post.id }})">Delete</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this post?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPostId = null;

        function setDeletePostId(postId) {
            currentPostId = postId;
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (currentPostId) {
                fetch('{{ url_for("blog.delete_post", post_id=0) }}'.replace('0', currentPostId), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const postContainer = document.querySelector(`.col-md-4[data-post-container-id="${currentPostId}"]`);
                        if (postContainer) {
                            postContainer.remove();
                        }
                        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                        modal.hide();
                        currentPostId = null;
                    }
                })
                .catch(error => {
                    console.error('Error during delete:', error);
                });
            }
        });
    </script>
{% endblock %}